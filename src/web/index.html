<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavalink Status Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --amoled-black: #000000;
            --amoled-card: #111111;
            --amoled-accent: #6d28d9;
            --amoled-text: #e5e7eb;
            --amoled-secondary: #1a1a1a;
            --amoled-success: #10b981;
            --amoled-danger: #ef4444;
            --amoled-warning: #f59e0b;
            --amoled-info: #3b82f6;
        }
        /* (CSS unchanged for brevity - copy your own or above as needed) */
    </style>
</head>

<body>
    <nav class="nav-gradient p-4 fixed w-full top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-server text-purple-600 text-2xl animate-float"></i>
                <h1 class="text-xl font-bold glow-text">Lavalink Status</h1>
            </div>
            <div class="flex items-center space-x-4">
                <a href="https://github.com/ghryanx7" target="_blank"
                    class="flex items-center space-x-2 bg-amoled-secondary hover:bg-gray-900 px-4 py-2 rounded-lg transition-colors duration-200">
                    <i class="fab fa-github"></i>
                    <span>GitHub</span>
                </a>
                <button id="refresh-btn"
                    class="flex items-center space-x-2 bg-amoled-secondary hover:bg-gray-900 px-4 py-2 rounded-lg transition-colors duration-200">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto pt-24 pb-16 px-4">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold">Node Status Overview</h2>
            <div class="flex items-center space-x-2">
                <span id="last-updated" class="text-sm text-gray-400">Last updated: Just now</span>
                <span id="next-refresh" class="text-sm px-2 py-1 rounded-full bg-purple-900 text-purple-200">Next refresh: 60s</span>
            </div>
        </div>

        <div id="loading" class="text-center py-12">
            <div class="loading-spinner mb-4 mx-auto"></div>
            <p class="text-lg">Connecting to Lavalink nodes...</p>
        </div>

        <div id="stats" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>

        <div id="error-message" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Connection Error</h3>
            <p class="mb-4">Unable to connect to Lavalink servers. Please check your connection.</p>
            <button id="retry-btn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                Retry Connection
            </button>
        </div>
    </main>

    <script>
    // Helper to fetch both stats and info arrays and zip them by node index
    async function fetchStatsAndInfos() {
        const [statsRes, infoRes] = await Promise.all([
            fetch('/stats'),
            fetch('/info')
        ]);
        if (!statsRes.ok || !infoRes.ok) throw new Error("Failed to fetch");
        const stats = await statsRes.json();
        const infos = await infoRes.json();
        // Zip by index (assuming both endpoints return arrays in the same order as config)
        return stats.map((stat, i) => ({ stat, info: infos[i] || {} }));
    }
    function formatBytes(bytes, decimals = 2) {
        if (isNaN(bytes) || bytes === 0) return '0 Bytes';
        const k = 1024,
            dm = decimals < 0 ? 0 : decimals,
            sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
            i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    function formatUptime(uptime) {
        if (typeof uptime === 'string') return uptime;
        const seconds = typeof uptime === 'number' ? Math.floor(uptime / 1000) : 0;
        if (seconds <= 0) return "0d 0h 0m";
        const days = Math.floor(seconds / 86400),
            hours = Math.floor((seconds % 86400) / 3600),
            minutes = Math.floor((seconds % 3600) / 60);
        return `${days}d ${hours}h ${minutes}m`;
    }
    function updateLastUpdated() {
        const now = new Date();
        document.getElementById('last-updated').textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }
    function updateNextRefresh(sec) {
        document.getElementById('next-refresh').textContent = `Next refresh: ${sec}s`;
    }
    let refreshTimer, refreshSec = 60;
    function startRefreshTimer(fetchFn) {
        clearInterval(refreshTimer);
        refreshSec = 60;
        updateNextRefresh(refreshSec);
        refreshTimer = setInterval(() => {
            refreshSec--;
            updateNextRefresh(refreshSec);
            if (refreshSec <= 0) {
                clearInterval(refreshTimer);
                fetchFn();
            }
        }, 1000);
    }
    async function render() {
        const loading = document.getElementById('loading');
        const statsDiv = document.getElementById('stats');
        const errorDiv = document.getElementById('error-message');
        loading.style.display = '';
        statsDiv.innerHTML = '';
        errorDiv.classList.add('hidden');
        try {
            const nodes = await fetchStatsAndInfos();
            loading.style.display = 'none';
            if (!Array.isArray(nodes) || nodes.length === 0) throw new Error("No nodes found");
            nodes.forEach(({ stat, info }) => {
                // Handle fallback if v3/v4 payloads are different
                const versionDisp = info.version?.semver || info.version?.build || info.version || "Unknown";
                const lavaplayerDisp = info.lavaplayer || "Unknown";
                const srcMgrs = (info.sourceManagers ?? []).join(', ') || "Unknown";
                const plugins = Array.isArray(info.plugins) && info.plugins.length
                    ? info.plugins.map(p => `${p.name} v${p.version}`).join(', ')
                    : "None";
                const status = stat.online ? "Online" : "Offline";
                const systemLoad = isNaN(stat.systemLoad) ? 0 : stat.systemLoad;
                const lavalinkLoad = isNaN(stat.lavalinkLoad) ? 0 : stat.lavalinkLoad;
                // Memory
                let memoryUsed, memoryReservable, memoryPerc;
                if (typeof stat.memoryUsed === 'string') {
                    memoryUsed = stat.memoryUsed;
                    memoryReservable = stat.memoryReservable;
                    // Try to parse numeric value for % (best effort, not critical)
                    const parseMem = s => {
                        if (!s) return 0;
                        const [num, unit] = s.split(' ');
                        const n = parseFloat(num);
                        if (isNaN(n)) return 0;
                        switch ((unit || '').toUpperCase()) {
                            case 'GB': return n * 1024 * 1024 * 1024;
                            case 'MB': return n * 1024 * 1024;
                            case 'KB': return n * 1024;
                            case 'B': return n;
                            default: return n;
                        }
                    };
                    const used = parseMem(stat.memoryUsed), reservable = parseMem(stat.memoryReservable);
                    memoryPerc = reservable > 0 ? Math.round((used / reservable) * 100) : 0;
                } else {
                    memoryUsed = formatBytes(isNaN(stat.memoryUsed) ? 0 : stat.memoryUsed);
                    memoryReservable = formatBytes(isNaN(stat.memoryReservable) ? 0 : stat.memoryReservable);
                    memoryPerc = (isNaN(stat.memoryUsed) || isNaN(stat.memoryReservable) || stat.memoryReservable === 0)
                        ? 0 : Math.round((stat.memoryUsed / stat.memoryReservable) * 100);
                }
                // Uptime
                const uptimeStr = formatUptime(stat.uptime);
                // Compose card
                const card = document.createElement('div');
                card.className = "card p-5 hover:shadow-lg transition-all";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold flex items-center">
                                ${stat.node}
                                <span class="status-badge ${stat.online ? 'online' : 'offline'} ml-2">
                                    <i class="fas fa-circle ${stat.online ? 'text-green-500' : 'text-red-500'} mr-1" style="font-size: 6px;"></i>
                                    ${status}
                                </span>
                            </h3>
                            <p class="text-sm text-gray-400">${stat.status}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold ${stat.online ? 'text-purple-400' : 'text-gray-500'}">${stat.activePlayers ?? 0}</p>
                            <p class="text-xs text-gray-400">Active Players</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>System Load</span>
                            <span>${systemLoad}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar progress-system" style="width: ${systemLoad}%"></div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Lavalink Load</span>
                            <span>${lavalinkLoad}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar progress-lavalink" style="width: ${lavalinkLoad}%"></div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Memory Usage</span>
                            <span>${memoryPerc}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar progress-memory" style="width: ${memoryPerc}%"></div>
                        </div>
                        <div class="text-xs text-right mt-1 text-gray-500">
                            ${memoryUsed} / ${memoryReservable}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                        <div>
                            <p class="text-gray-400">Uptime</p>
                            <p>${uptimeStr}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">CPU Cores</p>
                            <p>${stat.cores ?? 0}</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-xs text-gray-400 mb-1">Lavalink Version: <b>${versionDisp}</b> | Lavaplayer: <b>${lavaplayerDisp}</b></p>
                        <p class="text-xs text-gray-400 mb-1">Sources: <b>${srcMgrs}</b></p>
                        <p class="text-xs text-gray-400 mb-1">Plugins: <b>${plugins}</b></p>
                    </div>
                `;
                statsDiv.appendChild(card);
            });
            updateLastUpdated();
            startRefreshTimer(render);
        } catch (e) {
            loading.style.display = 'none';
            statsDiv.innerHTML = '';
            document.getElementById('error-message').classList.remove('hidden');
        }
    }
    document.getElementById('refresh-btn').addEventListener('click', () => {
        render();
        startRefreshTimer(render);
    });
    document.getElementById('retry-btn').addEventListener('click', () => {
        render();
        startRefreshTimer(render);
    });
    window.onload = () => {
        render();
        startRefreshTimer(render);
    };
    </script>
</body>
</html>
